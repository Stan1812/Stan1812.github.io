<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Shady"><title>如何监听js中变量的变化 · Libx</title><meta name="description" content="原生JS监听变量的变化今天在刷知乎的时候遇到了这样的一个问题:如何侦听JS中变量的变化首先想到的是在Vue中的数据绑定，但是上车时间不长，是直接拿来用的。。并不知道实现原理，想了又想，没有好的解决方案。看到有大佬的答案后依然很迷，遂google一番，总结一下。
几种解决方案：ES5的getter与s"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><h3 title=""><a href="/">Libx</a></h3><div class="description"><p>Thoughts,stories and ideas</p></div></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>© 2017 — 2018 ❤ Shady</span></a></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">Sobre</a></li><li><a href="/archives">Arquivo</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>如何监听js中变量的变化</a></h3></div><div class="post-content"><h2 id="原生JS监听变量的变化"><a href="#原生JS监听变量的变化" class="headerlink" title="原生JS监听变量的变化"></a>原生JS监听变量的变化</h2><p>今天在刷知乎的时候遇到了这样的一个问题:<a href="https://www.zhihu.com/question/44724640?sort=created" target="_blank" rel="external">如何侦听JS中变量的变化</a>首先想到的是在Vue中的数据绑定，但是上车时间不长，是直接拿来用的。。并不知道实现原理，想了又想，没有好的解决方案。看到有大佬的答案后依然很迷，遂google一番，总结一下。</p>
<h2 id="几种解决方案："><a href="#几种解决方案：" class="headerlink" title="几种解决方案："></a>几种解决方案：</h2><h3 id="ES5的getter与setter"><a href="#ES5的getter与setter" class="headerlink" title="ES5的getter与setter"></a>ES5的getter与setter</h3><p>主要使用的是：<code>Object.defineProperty(obj, prop, descriptor)</code></p>
<p> <strong>参数</strong> ：</p>
<ul>
<li>obj 需要被操作的目标对象</li>
<li>prop 目标对象需要定义或修改的属性的名称。</li>
<li>descriptor 将被定义或修改的属性的描述符。</li>
</ul>
<p><strong>返回值</strong> :</p>
<ul>
<li>被传递给函数的对象</li>
</ul>
<p>以下是MDN的相关定义：</p>
<blockquote>
<p>该方法允许精确添加或修改对象的属性。一般情况下，我们为对象添加属性是通过赋值来创建并显示在属性枚举中（for…in 或 Object.keys 方法）， 但这种方式添加的属性值可以被改变，也可以被删除。而使用 Object.defineProperty() 则允许改变这些额外细节的默认设置。例如，默认情况下，使用  Object.defineProperty() 增加的属性值是不可改变的。</p>
<p>对象里目前存在的属性描述符有两种主要形式：数据描述符和存取描述符。数据描述符是一个拥有可写或不可写值的属性。存取描述符是由一对 getter-setter 函数功能来描述的属性。描述符必须是两种形式之一；不能同时是两者。</p>
<p>数据描述符和存取描述符均具有以下可选键值：</p>
<blockquote>
<ul>
<li>configurable<br>当且仅当该属性的 configurable 为 true 时，该属性描述符才能够被改变，同时该属性也能从对应的对象上被删除。默认为 false。</li>
<li>enumerable<br>当且仅当该属性的 enumerable 为 true 时，该属性才能够出现在对象的枚举属性中。默认为 false。</li>
</ul>
</blockquote>
<p>数据描述符同时具有以下可选键值：</p>
<blockquote>
<p>value<br>该属性对应的值。可以是任何有效的 JavaScript 值（数值，对象，函数等）。默认为 undefined。<br>writable<br>当且仅当该属性的 writable 为 true 时，该属性才能被赋值运算符改变。默认为 false。</p>
</blockquote>
<p>存取描述符同时具有以下可选键值：</p>
<blockquote>
<ul>
<li>get:<br>一个给属性提供 getter 的方法，如果没有 getter 则为 undefined。该方法返回值被用作属性值。默认为 undefined。</li>
<li>set<br>一个给属性提供 setter 的方法，如果没有 setter 则为 undefined。该方法将接受唯一参数，并将该参数的新值分配给该属性。默认为 undefined。</li>
</ul>
</blockquote>
</blockquote>
<p>定义看起来感觉有点复杂，而如果深入的讨论的话更加复杂，完全当手册用了，我们在此只关注基本的setter和getter</p>
<p>下面的例子说明了如何实现自我存档的对象。当 temperature 属性设置时，archive 数组会得到一个 log<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Archiver</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> temperature = <span class="literal">null</span>;</div><div class="line">  <span class="keyword">var</span> archive = [];</div><div class="line"></div><div class="line">  <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, <span class="string">'temperature'</span>, &#123;</div><div class="line">    get: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'get!'</span>);</div><div class="line">      <span class="keyword">return</span> temperature;</div><div class="line">    &#125;,</div><div class="line">    set: <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">      temperature = value;</div><div class="line">      archive.push(&#123; <span class="attr">val</span>: temperature &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.getArchive = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> archive; &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> arc = <span class="keyword">new</span> Archiver();</div><div class="line">arc.temperature; <span class="comment">// 'get!'</span></div><div class="line">arc.temperature = <span class="number">11</span>;</div><div class="line">arc.temperature = <span class="number">13</span>;</div><div class="line">arc.getArchive(); <span class="comment">// [&#123; val: 11 &#125;, &#123; val: 13 &#125;]</span></div></pre></td></tr></table></figure></p>
<p>另一个例子：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> pattern = &#123;</div><div class="line">    get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'I alway return this string,whatever you have assigned'</span>;</div><div class="line">    &#125;,</div><div class="line">    set: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.myname = <span class="string">'this is my name string'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">TestDefineSetAndGet</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, <span class="string">'myproperty'</span>, pattern);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> instance = <span class="keyword">new</span> TestDefineSetAndGet();</div><div class="line">instance.myproperty = <span class="string">'test'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 'I alway return this string,whatever you have assigned'</span></div><div class="line"><span class="built_in">console</span>.log(instance.myproperty);</div><div class="line"><span class="comment">// 'this is my name string'</span></div><div class="line"><span class="built_in">console</span>.log(instance.myname);</div></pre></td></tr></table></figure>
<p>这两个例子很好。</p>
<p>另外：IE8及更低版本IE是无法使用的，而且这个特性是没有polyfill的，无法在不支持的平台实现。</p>
<h3 id="Object-observe"><a href="#Object-observe" class="headerlink" title="Object.observe()"></a>Object.observe()</h3><p>Object.observe() 方法用于异步地监视一个对象的修改。当对象属性被修改时，方法的回调函数会提供一个有序的修改流。然而，这个接口已经被废弃并从各浏览器中移除。但是在我看了这几种解决方案之后，反而觉得这是种很好的解决方案。。</p>
<p>简单的介绍一下</p>
<p><code>Object.observe(obj, callback[, acceptList])</code></p>
<ul>
<li>obj 被监控的对象.</li>
<li><p>callback 当对象被修改时触发的回调函数，其参数为: </p>
<ul>
<li><p>changes 一个数组，其中包含的每一个对象代表一个修改行为。每个修改行为的对象包含: </p>
<ul>
<li>name: 被修改的属性名称。</li>
<li>object: 修改后该对象的值。</li>
<li>type: 表示对该对象做了何种类型的修改，可能的值为”add”, “update”, or “delete”。</li>
<li>oldValue: 对象修改前的值。该值只在”update”与”delete”有效。</li>
</ul>
</li>
<li><p>acceptList 在给定对象上给定回调中要监视的变化类型列表。如果省略， [“add”, “update”, “delete”, “reconfigure”, “setPrototype”, “preventExtensions”] 将会被使用。</p>
</li>
</ul>
</li>
</ul>
<p>数据绑定的示例：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 一个数据模型</span></div><div class="line"><span class="keyword">var</span> user = &#123;</div><div class="line">  id: <span class="number">0</span>,</div><div class="line">  name: <span class="string">'Brendan Eich'</span>,</div><div class="line">  title: <span class="string">'Mr.'</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 创建用户的greeting</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateGreeting</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  user.greeting = <span class="string">'Hello, '</span> + user.title + <span class="string">' '</span> + user.name + <span class="string">'!'</span>;</div><div class="line">&#125;</div><div class="line">updateGreeting();</div><div class="line"></div><div class="line"><span class="built_in">Object</span>.observe(user, <span class="function"><span class="keyword">function</span>(<span class="params">changes</span>) </span>&#123;</div><div class="line">  changes.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">change</span>) </span>&#123;</div><div class="line">    <span class="comment">// 当name或title属性改变时, 更新greeting</span></div><div class="line">    <span class="keyword">if</span> (change.name === <span class="string">'name'</span> || change.name === <span class="string">'title'</span>) &#123;</div><div class="line">      updateGreeting();</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="使用ES6中的proxy"><a href="#使用ES6中的proxy" class="headerlink" title="使用ES6中的proxy"></a>使用ES6中的proxy</h3><p>proxy可以说是一个比较庞大的东西了，他可以做的事情有很多</p>
<p><code>let p = new Proxy(target, handler);</code></p>
<p><strong>参数</strong>: </p>
<ul>
<li>target 一个目标对象(可以是任何类型的对象，包括本机数组，函数，甚至另一个代理)用Proxy来包装。</li>
<li>handler  一个对象，其属性是当执行一个操作时定义代理的行为的函数。 <figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">通过代理，你可以轻松地验证向一个对象的传值。</div><div class="line"></div><div class="line">以下例子使用了 set 处理器（set handler）。</div><div class="line"></div><div class="line"><span class="keyword">let</span> validator = &#123;</div><div class="line">  set: <span class="function"><span class="keyword">function</span>(<span class="params">obj, prop, value</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (prop === <span class="string">'age'</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (!<span class="built_in">Number</span>.isInteger(value)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'The age is not an integer'</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (value &gt; <span class="number">200</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RangeError</span>(<span class="string">'The age seems invalid'</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// The default behavior to store the value</span></div><div class="line">    obj[prop] = value;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">let</span> person = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, validator);</div><div class="line"></div><div class="line">person.age = <span class="number">100</span>;</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(person.age); </div><div class="line"><span class="comment">// 100</span></div><div class="line"></div><div class="line">person.age = <span class="string">'young'</span>; </div><div class="line"><span class="comment">// 抛出异常: Uncaught TypeError: The age is not an integer</span></div><div class="line"></div><div class="line">person.age = <span class="number">300</span>; </div><div class="line"><span class="comment">// 抛出异常: Uncaught RangeError: The age seems invalid</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>这是一个在官方文档上的实例：它使用了set handler，监听了数据的改变。</p>
<p>暂时就这些吧</p>
<p>参考文章：</p>
<ul>
<li><a href="https://www.zhihu.com/question/44724640?sort=created" target="_blank" rel="external">如何侦听JS中变量的变化</a>中<a href="https://www.zhihu.com/people/daraw/answers" target="_blank" rel="external">@月迷津渡</a>的回答</li>
<li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="external"> MDN Object.defineProperty()</a></p>
</li>
<li><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/observe" target="_blank" rel="external">MDN Object.observe()</a></p>
</li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy" target="_blank" rel="external">MDN Proxy</a></li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-08-30</span><i class="fa fa-tag"></i><a class="tag" href="/categories/技术/" title="技术">技术 </a><a class="tag" href="/tags/JS/" title="JS">JS </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://stan1812.github.io/2017/08/30/中变量的变化/,Libx,如何监听js中变量的变化,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/09/04/JS-depth1/" title="JS深浅拷贝">Post Anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/08/25/e5-a4-a7-e4-b8-80-e4-b8-80-e5-b9-b4/" title="大一一年">Próximo post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>