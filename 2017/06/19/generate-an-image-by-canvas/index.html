<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Shady"><title>Generate an image by canvas · Libx</title><meta name="description" content="嗯，很久没写东西了，是的，我们考完了试，这个辣鸡小项目基本上也算是完成了，按照惯例，对于这个垃圾小项目来总结点东西。
项目的 Github 地址在这里 ，在线预览地址在这里
因为在学习Canvas就想做些有意思的东西
这是一个类似于网上流传的很多的那种输入汉字然后自动生成表情包的小东西，然后就想要来"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><h3 title=""><a href="/">Libx</a></h3><div class="description"><p>Thoughts,stories and ideas</p></div></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="/"><span>© 2017 — 2018 ❤ Shady</span></a></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Generate an image by canvas</a></h3></div><div class="post-content"><p>嗯，很久没写东西了，是的，我们考完了试，这个辣鸡小项目基本上也算是完成了，按照惯例，对于这个垃圾小项目来总结点东西。</p>
<p>项目的 Github 地址在<a href="https://github.com/Stan1812/Generate-an-image-by-canvas" target="_blank" rel="external">这里</a> ，在线预览地址在<a href="https://stan1812.github.io/Generate-an-image-by-canvas/">这里</a></p>
<p>因为在学习Canvas就想做些有意思的东西</p>
<p>这是一个类似于网上流传的很多的那种输入汉字然后自动生成表情包的小东西，然后就想要来试一下</p>
<h3 id="最终将实现的功能："><a href="#最终将实现的功能：" class="headerlink" title="最终将实现的功能："></a><a href="https://github.com/Stan1812/Generate-an-image-by-canvas#最终将实现的功能" target="_blank" rel="external"></a>最终将实现的功能：</h3><p>最终实现的功能大概有这些：</p>
<ul>
<li>用户可以自由上传图片，自由编辑文字内容，并选择插入文字的位置</li>
<li>下载生成的图片</li>
<li>原笔迹的书写</li>
<li>图片下载寒酸的裁剪功能</li>
<li>几种图片滤镜：黑白，负片以及更多</li>
</ul>
<hr>
<h4 id="上传图片"><a href="#上传图片" class="headerlink" title="上传图片"></a>上传图片</h4><p>上传图片在这里使用的是HTML5中的filereader来实现的，将图片以DataURL的形式读入页面，在上传前通过输入缩放倍数来选择大小 后期考虑引入滑块式的调整各种参数，直接输入的方法真的是。。</p>
<p>具体的代码实现如下：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">readAsDataURL</span>(<span class="params"></span>)</span>&#123;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (!<span class="built_in">document</span>.getElementById(<span class="string">'read_pic_but'</span>).className) </div><div class="line">			&#123;<span class="built_in">document</span>.getElementById(<span class="string">'read_pic_but'</span>).className+=<span class="string">'button'</span>;&#125;</div><div class="line">		<span class="keyword">else</span>&#123;<span class="built_in">document</span>.getElementById(<span class="string">'read_pic_but'</span>).className=<span class="string">""</span>&#125;</div><div class="line">		<span class="built_in">console</span>.log(<span class="built_in">document</span>.getElementById(<span class="string">'read_pic_but'</span>).className)</div><div class="line"></div><div class="line">		<span class="comment">//检验是否为图像文件</span></div><div class="line">		<span class="keyword">var</span> file = <span class="built_in">document</span>.getElementById(<span class="string">"uppic"</span>).files[<span class="number">0</span>];</div><div class="line">		<span class="keyword">if</span>(!<span class="regexp">/image\/\w+/</span>.test(file.type))&#123;</div><div class="line">				alert(<span class="string">'仅支持上传图片'</span>);</div><div class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</div><div class="line">		<span class="comment">//将文件以Data URL形式读入页面</span></div><div class="line">		reader.readAsDataURL(file);</div><div class="line">		reader.onload=<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">				<span class="keyword">var</span> picture=<span class="keyword">this</span>.result;</div><div class="line">				<span class="keyword">var</span> pic=<span class="keyword">new</span> Image();</div><div class="line">				pic.src=picture;</div><div class="line">				<span class="comment">//调整图片的大小</span></div><div class="line">				<span class="keyword">var</span> scal_control=<span class="built_in">document</span>.getElementById(<span class="string">'_scale'</span>).value; </div><div class="line"></div><div class="line">				<span class="keyword">if</span> (scal_control!=<span class="string">""</span>) </div><div class="line">				&#123; ctx.scale(scal_control,scal_control);&#125;</div><div class="line">			<span class="keyword">if</span> (scal_control=<span class="string">""</span>)</div><div class="line">			&#123;</div><div class="line">					scal_control= <span class="number">1</span>;</div><div class="line">					ctx.scale(scal_control,scal_control);     		</div><div class="line">				&#125;;</div><div class="line"></div><div class="line">				<span class="built_in">console</span>.log(scal_control);</div><div class="line">				ctx.drawImage(pic,<span class="number">0</span>,<span class="number">0</span>)</div><div class="line">				<span class="keyword">return</span> pic;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码写的有点烂，以后再看一下有没有重构的价值，如果有时间的话还是希望把代码重构一下</p>
<h4 id="下载图片"><a href="#下载图片" class="headerlink" title="下载图片"></a><a href="https://github.com/Stan1812/Generate-an-image-by-canvas#下载图片" target="_blank" rel="external"></a>下载图片</h4><p>下载图片时是可以选择保存图片的格式的，但是考虑到在使用时的繁琐，就直接设置为了jpg格式。 在canvas中保存图片是使用的toDataURL来做的。在保存的时候比较关键的一个就是要将MIME类型改为image/object-stream。得到的图片data:image/png;base64需要更改一下</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> fixtype = <span class="function"><span class="keyword">function</span> (<span class="params">type</span>) </span>&#123;</div><div class="line">         type = type.toLocaleLowerCase().replace(<span class="regexp">/jpg/i</span>, <span class="string">'jpeg'</span>);</div><div class="line">   	    <span class="keyword">var</span> r = type.match(<span class="regexp">/png|jpeg|bmp|gif/</span>)[<span class="number">0</span>];</div><div class="line">   	    <span class="keyword">return</span> <span class="string">'image/'</span> + r;</div><div class="line">   		&#125;</div><div class="line">     imgdata = imgdata.replace(fixtype(type), <span class="string">'image/octet-stream'</span>)</div></pre></td></tr></table></figure>
<h4 id="图片处理"><a href="#图片处理" class="headerlink" title="图片处理"></a><a href="https://github.com/Stan1812/Generate-an-image-by-canvas#图片处理" target="_blank" rel="external"></a>图片处理</h4><p>说是图片处理，我都不好意思了hhh</p>
<ul>
<li>添加文字：使用是canvas中自有的渲染文字的方法，可以选择字体颜色 取色器使用getImageData做，得到的数据是一个数组，每四位分别表示一个像素点的RGBA数据。取到该像素点的数据，简单的字符处理就可得到可用的颜色数据。 这里就只是把取色部分的代码写一下吧：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">pick</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">   	<span class="keyword">var</span> x = event.offsetX;</div><div class="line">   	<span class="keyword">var</span> y = event.offsetY;</div><div class="line">   	<span class="keyword">var</span> pixel = ctx2.getImageData(x, y, <span class="number">1</span>, <span class="number">1</span>);</div><div class="line">   	<span class="keyword">var</span> data = pixel.data;</div><div class="line">   	<span class="keyword">var</span> rgba = <span class="string">'rgba('</span> + data[<span class="number">0</span>] + <span class="string">','</span> + data[<span class="number">1</span>] + <span class="string">','</span> + data[<span class="number">2</span>] + <span class="string">','</span> + (data[<span class="number">3</span>] / <span class="number">255</span>) + <span class="string">')'</span>;</div><div class="line">   	color.style.background = rgba;</div><div class="line">   	color.textContent = rgba;</div><div class="line">   	<span class="built_in">console</span>.log(rgba,x,y)</div><div class="line">   	ctx.fillStyle=rgba;</div><div class="line">   	ctx.strokeStyle=rgba;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>原笔迹书写：监听鼠标的move up down 使用了line_X,line_Y,line_N三个数组分别储存的轨迹的X Y坐标，和鼠标是否按下的标志信息，当鼠标按下并移动时分别向数组X，Y ，N push该点坐标及标识位信息，然后整个遍历一次数组，标志位为1时lineTo（X，Y），标志位为0时移动坐标，进行下一笔画的渲染。突然发现这样遍历成本很高，回头改改.代码在这里：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">   <span class="keyword">var</span> linex = <span class="keyword">new</span> <span class="built_in">Array</span>();    </div><div class="line"><span class="keyword">var</span> liney = <span class="keyword">new</span> <span class="built_in">Array</span>();     </div><div class="line"><span class="keyword">var</span> linen = <span class="keyword">new</span> <span class="built_in">Array</span>();     </div><div class="line"><span class="keyword">var</span> lastX = <span class="number">-1</span>;     </div><div class="line"><span class="keyword">var</span> lastY = <span class="number">-1</span>;     </div><div class="line"><span class="keyword">var</span> flag = <span class="number">0</span>;    </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">line_drawer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">   	canvas.addEventListener(<span class="string">'mousemove'</span>, onMouseMove, <span class="literal">false</span>);     </div><div class="line">	canvas.addEventListener(<span class="string">'mousedown'</span>, onMouseDown, <span class="literal">false</span>);     </div><div class="line">	canvas.addEventListener(<span class="string">'mouseup'</span>, onMouseUp, <span class="literal">false</span>);     </div><div class="line">		<span class="function"><span class="keyword">function</span> <span class="title">onMouseMove</span>(<span class="params">evt</span>) </span>&#123;    		</div><div class="line">			<span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;    			 </div><div class="line">				linex.push(evt.layerX);    			</div><div class="line">				 liney.push(evt.layerY);    			 </div><div class="line">				 linen.push(<span class="number">1</span>);    			 </div><div class="line">				 ctx.beginPath();    			 </div><div class="line">				 ctx.lineWidth = <span class="number">1</span> + <span class="built_in">Math</span>.random() * <span class="number">5</span>;    			 </div><div class="line">			<span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">1</span>;i&amp;lt;linex.length;i++) &#123;    						 </div><div class="line">				lastX = linex[i];    						 </div><div class="line">				lastY = liney[i];    						 </div><div class="line">				<span class="keyword">if</span> (linen[i] == <span class="number">0</span>) &#123;    								</div><div class="line">					ctx.moveTo(lastX,lastY);    						 </div><div class="line">					&#125; <span class="keyword">else</span> &#123;    								</div><div class="line">						ctx.lineTo(lastX,lastY);    						 </div><div class="line">						&#125;    			 </div><div class="line">					&#125;    			 </div><div class="line">					ctx.stroke();</div><div class="line">   		&#125;     &#125;     </div><div class="line">		<span class="function"><span class="keyword">function</span> <span class="title">onMouseDown</span>(<span class="params">evt</span>) </span>&#123;    		</div><div class="line">			flag = <span class="number">1</span>;    		</div><div class="line">			linex.push(evt.layerX);    		</div><div class="line">			liney.push(evt.layerY);    		</div><div class="line">			linen.push(<span class="number">0</span>);     </div><div class="line">			&#125;     </div><div class="line">		<span class="function"><span class="keyword">function</span> <span class="title">onMouseUp</span>(<span class="params">evt</span>) </span>&#123;    		</div><div class="line">			flag = <span class="number">0</span>;    		 </div><div class="line">			linex.push(evt.layerX);    		</div><div class="line">			liney.push(evt.layerY);    		</div><div class="line">			linen.push(<span class="number">0</span>);     </div><div class="line">			&#125;    </div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h4 id="几种辣鸡滤镜"><a href="#几种辣鸡滤镜" class="headerlink" title="几种辣鸡滤镜"></a>几种辣鸡滤镜</h4><p>很简单的滤镜功能：</p>
<ul>
<li>负片：取到图片的数据，循环一次数组，分别将R位 G位 B位数据被255减即可。代码：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">negative</span>(<span class="params"></span>)</span>&#123;</div><div class="line">   		<span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&amp;lt;data_length;j+=<span class="number">4</span>)&#123;</div><div class="line">   			data0[j]=<span class="number">255</span>-data0[j];</div><div class="line">   			data0[j+<span class="number">1</span>]=<span class="number">255</span>-data0[j+<span class="number">1</span>];</div><div class="line">   			data0[j+<span class="number">2</span>]=<span class="number">255</span>-data0[j+<span class="number">2</span>];</div><div class="line">   		&#125;</div><div class="line">   		ctx.putImageData(imageData0, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">   		<span class="built_in">console</span>.log(imageData0);</div><div class="line">   	&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>黑白：同样拿到数据，步阶为4，将r、g、b位求平均值，然后rgb均等该改平均值即可。 代码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">grayscale</span>(<span class="params">id</span>)  </span>&#123;</div><div class="line">  			<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &amp;lt; data_length; i += <span class="number">4</span>) &#123;</div><div class="line">  			 <span class="keyword">var</span> avg = (data0[i] + data0[i + <span class="number">1</span>] + data0[i + <span class="number">2</span>]) / <span class="number">3</span>;</div><div class="line">  				data0[i]     = avg; <span class="comment">// red</span></div><div class="line">  				data0[i + <span class="number">1</span>] = avg; <span class="comment">// green</span></div><div class="line">  				data0[i + <span class="number">2</span>] = avg; <span class="comment">// blue</span></div><div class="line">  			&#125;</div><div class="line">  			ctx.putImageData(imageData0, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">  			<span class="built_in">console</span>.log(imageData0);</div><div class="line">  		&#125;;</div></pre></td></tr></table></figure>
</li>
<li><p>高斯模糊：这里引入了一个StackBlur.js，自己写有点应付不来。。 大概就是这些吧。</p>
</li>
</ul>
<h2 id="学到了什么？"><a href="#学到了什么？" class="headerlink" title="学到了什么？"></a><a href="https://github.com/Stan1812/Generate-an-image-by-canvas#学到了什么" target="_blank" rel="external"></a>学到了什么？</h2><p>技术方面的不再说，说一些软的东西吧。 一个完整项目中的一些命名规则，变量的处理，包括全局和私有变量选择，函数的处理，如何解决函数间的通信等 另外，在整个项目开始之前的大概的规划，就算是练手的小项目，大致要做成什么样子也要有一个底。不然在写的时候很容易越写越乱。 另外，代码规范！这个东西并未严格的按照家园的前端代码规范来写，因为觉得只是练手吧，直到现在开始接触Vue 工作室要求使用Eslint来规范代码，真的很难受。。这个东西还是从开始就养好习惯比较好。不要因为追求速度而忽视了这些‘软实力’。 就这些吧~</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-06-19</span><i class="fa fa-tag"></i><a class="tag" href="/categories/技术/" title="技术">技术 </a><a class="tag" href="/tags/JS/" title="JS">JS </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://stan1812.github.io/2017/06/19/generate-an-image-by-canvas/,Libx,Generate an image by canvas,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2017/08/11/e5-88-9d-e6-8e-a2vue/" title="初探Vue">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2017/06/01/e4-b8-80-e4-bb-a3-e5-ae-97-e5-b8-88/" title="一代宗师">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>